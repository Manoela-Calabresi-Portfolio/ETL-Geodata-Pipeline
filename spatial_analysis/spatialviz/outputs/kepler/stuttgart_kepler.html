<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stuttgart â€” Kepler.gl</title>
<style>
  html, body, #app { height:100%; margin:0 }
  #app { position:relative; }
  .token { position:absolute; top:10px; right:10px; background:#0f172a; color:#e2e8f0; padding:8px 12px; border-radius:8px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px; opacity:.8 }
  .title { position:absolute; top:10px; left:10px; background:#0f172a; color:#e2e8f0; padding:8px 12px; border-radius:8px; font-family:ui-sans-serif,system-ui,sans-serif; font-size:14px; font-weight:600; opacity:.9; z-index:1000 }
</style>
<!-- Kepler/Deck/Mapbox from CDN -->
<script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/kepler.gl/umd/keplergl.min.js"></script>
<script src="https://unpkg.com/mapbox-gl@2.9.2/dist/mapbox-gl.js"></script>
<link href="https://unpkg.com/mapbox-gl@2.9.2/dist/mapbox-gl.css" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/kepler.gl/umd/keplergl.min.css" />
</head>
<body>
<div id="app"></div>
<div class="title">Stuttgart H3 Spatial Analysis</div>
<div class="token">Set MAPBOX_TOKEN in your env and reload if tiles don't show</div>
<script>
(async function() {
  // ====== Load data (relative to this HTML) ======
  async function maybe(url) {
    try { const r = await fetch(url); if (!r.ok) return null; return await r.json(); } catch(e){ return null; }
  }
  const datasets = [];
  const districts = await maybe("./districts.geojson");
  if (districts) datasets.push({id:"districts", label:"districts", data: districts});
  const greens = await maybe("./greens.geojson");
  if (greens) datasets.push({id:"greens", label:"greens", data: greens});
  const cycle = await maybe("./cycle.geojson");
  if (cycle) datasets.push({id:"cycle", label:"cycle", data: cycle});
  const stops = await maybe("./pt_stops.geojson");
  if (stops) datasets.push({id:"pt_stops", label:"pt_stops", data: stops});

  const cfg = await (await fetch("../../kepler/configs/stuttgart_kepler.json")).json();

  // ====== Mapbox token ======
  const token = (window.MAPBOX_TOKEN) || (localStorage.getItem("MAPBOX_TOKEN") || "");
  if (token) mapboxgl.accessToken = token;

  // ====== Mount Kepler ======
  const KeplerGl = window.keplergl.KeplerGl;
  const {useEffect, useState} = React;

  function App(){
    const [vis,setVis] = useState(null);
    useEffect(() => {
      if (!vis) return;
      // add datasets & config
      datasets.forEach(ds => vis.addDataToMap({datasets:{info:{id: ds.id, label: ds.label}, data: ds.data}, config: null}));
      if (cfg && cfg.config) vis.addDataToMap({datasets:[], config: cfg.config});
    }, [vis]);

    return React.createElement('div', {style:{height:'100%'}},
      React.createElement(KeplerGl, {
        id: "kepler",
        mapboxApiAccessToken: token || undefined,
        onLoad: v => setVis(v)
      })
    );
  }

  ReactDOM.render(React.createElement(App), document.getElementById('app'));
})();
</script>
</body>
</html>
